# MusicQuiz

Discordで音楽クイズを楽しむためのボットです。

## 機能

- 音楽ファイルを再生して曲名を当てるクイズ
- 複数選択肢からの回答
- スコア管理とランキング表示
- ゲーム用チャンネルとコマンド用チャンネルの分離
- **ゲーム用サーバーとコマンド用サーバーの分離**

## セットアップ

### 1. 必要なファイル

- `main.py` - メインのボットコード（エントリーポイント）
- `game_manager.py` - ゲーム管理機能（ゲーム状態、出題、スコア管理）
- `command_handler.py` - コマンド処理機能（コマンド実行、権限チェック）
- `config.ini` - 設定ファイル
- `requirements.txt` - 必要なPythonパッケージ
- 音楽データベースファイル（SQLite）

### 2. 設定ファイル（config.ini）

```ini
[DEFAULT]
# 基本設定
db_path = Your DB Path
log_path = ./log_event.txt
bot_token = Your Bot Token

# ゲーム用サーバー・チャンネル設定
game_guild_id = game_guild_id          # ゲーム用サーバーID（ゲームチャンネルが存在するサーバー）
game_channel_id = game_channel_id      # ゲーム用チャンネルID（クイズの出題・回答・結果表示）

# コマンド用サーバー・チャンネル設定
command_guild_id = command_guild_id    # コマンド用サーバーID（コマンドチャンネルが存在するサーバー）
command_channel_id = command_channel_id # コマンド用チャンネルID（/start, /next, /scoreなどのコマンド実行）

# ゲーム設定
rounds = 5
song_ids = 1, 2, 3, 4, 5
answer_seconds = 30
```

### 3. チャンネル・サーバー分離機能

このボットでは、ゲーム用とコマンド用でチャンネルを分離しています：

#### 3-1. 同一サーバー内での分離
- **ゲーム用チャンネル**: クイズの出題、音声ファイル、選択肢ボタン、結果表示
- **コマンド用チャンネル**: `/start`, `/next`, `/score`などのコマンド実行

#### 3-2. 別サーバー間での分離
- **ゲーム用サーバー**: クイズの出題、音声ファイル、選択肢ボタン、結果表示
- **コマンド用サーバー**: `/start`, `/next`, `/score`などのコマンド実行

設定方法：
1. **同一サーバー**: `game_channel_id`と`command_channel_id`のみ設定
2. **別サーバー**: `game_guild_id`、`command_guild_id`、`game_channel_id`、`command_channel_id`を全て設定
3. 設定しない場合は、同じチャンネルで全ての機能が動作

### 4. コマンド

- `/start` - ゲーム開始（コマンドサーバー・チャンネルでのみ実行可能）
- `/next` - 次の問題を出題（コマンドサーバー・チャンネルでのみ実行可能）
- `/answer` - 正解を発表（コマンドサーバー・チャンネルでのみ実行可能）
- `/score` - 現在のスコアまたは最終順位を表示（コマンドサーバー・チャンネルでのみ実行可能）

**コマンドボタン機能**: 各コマンド実行後、ボタンで操作できるコマンドパネルが表示されます。ボタンをクリックすることで、コマンドを簡単に実行できます。

**自動起動メッセージ**: ボットがログインすると、自動的にコマンド用チャンネルにコマンドボタン付きのメッセージが送信されます。これにより、すぐにゲームを開始できます。

### 5. 実行

```bash
pip install -r requirements.txt
python main.py --config configファイルのパス
```

## 注意事項

- ゲームサーバーとコマンドサーバーを分ける場合、ボットが両方のサーバーに参加している必要があります
- ゲームチャンネルとコマンドチャンネルを分ける場合、ボットが両方のチャンネルにアクセスできる権限が必要です
- 回答ボタンはゲームサーバー・チャンネルでのみ有効です
- コマンドはコマンドサーバー・チャンネルでのみ実行可能です
- 別サーバー間でのゲームの場合、ゲームサーバーのメンバー情報がスコア管理に使用されます

## 概要
MusicQuizは、Discordサーバー上で楽曲クイズを開催できるプログラムです。Botを使用して音声ファイルを送信し、選択肢から曲名を当てる形式のクイズを半自動で進行します。スコア管理や順位発表、ログ出力も自動で行います。

## 主な機能

- **/start**  
  クイズゲームを開始します。サーバー内のメンバー（Bot以外）を自動で参加者として登録します。

- **/next**  
  次の問題を出題します。音声ファイル（mp3）を送信し、選択肢付きの問題文を表示します。選択肢は自動生成または設定ファイルで指定可能です。

- **選択肢ボタンで回答**  
  各ユーザーは表示されたボタンから曲名を選んで回答できます。1ラウンドにつき1回のみ回答可能です。

- **自動タイマー**  
  回答受付は制限時間（デフォルト15秒）で自動的に締め切られます。

- **/score**  
  現在のスコアや最終順位を表示します。順位は自動で計算されます。

- **スコアログ出力**  
  各ラウンド終了時やゲーム終了時に、スコアのログをテキストファイルに出力します。

- **設定ファイル対応**  
  出題曲や選択肢、ラウンド数、制限時間などを`config.ini`で柔軟に設定できます。

## 必要なBot権限

- チャンネルの閲覧（View Channels）
- メッセージの送信（Send Messages）
- メッセージの管理（Manage Messages）※今は不要です。
- メッセージ履歴の閲覧（Read Message History）
- ファイルの添付（Attach Files）
- スラッシュコマンドの利用（Use Slash Commands）
- Permissions Interger = 2147593216（上記の権限をまとめたもの）

## 使い方

### 環境構築・セットアップ手順

1. Python 3.8以降をインストールしてください。
2. 必要なライブラリをインストールします。  
   ```
   pip install -r requirements.txt
   ```
3. `config.ini`を作成し、Botトークンや出題曲情報（データベースパス、ラウンド数など）を設定します。
4. 楽曲データベース（sqlite3形式、例: `songs.db`）を用意し、必要な楽曲情報を登録してください。
5. サーバーにBotを招待し、README記載の権限を付与します。
6. `main.py`を実行します。  
   ```
   python main.py --config configファイルのパス
   ```
7. Discordサーバーで`/start`コマンドを入力してクイズを開始します。

### 楽曲データベース（songs.db）のテーブル仕様

本プログラムは、楽曲情報をSQLite3データベースから取得します。  
データベースには、最低限以下のような`songs`テーブルが必要です。  
音声ファイルは5sほどに切り取りしているものを使用してください。

#### テーブル例

| カラム名   | 型         | 説明                       |
|:----------|:-----------|:---------------------------|
| id        | INTEGER    | 楽曲ID（主キー, AUTOINCREMENT推奨） |
| title     | TEXT       | 楽曲名                     |
| artist    | TEXT       | アーティスト名              |
| path      | TEXT       | 音声ファイルのフルパス（mp3等） |
